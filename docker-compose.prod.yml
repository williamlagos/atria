version: '3.8'

services:
    web:
        image: atria
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            - DJANGO_SETTINGS_MODULE=atria.settings
            - PYTHONDONTWRITEBYTECODE=1
            - PYTHONUNBUFFERED=1
            - DEBUG=0
        ports:
            - '8000:8000'
        depends_on:
            db:
                condition: service_healthy
        deploy:
            replicas: 2
            update_config:
                parallelism: 1
                delay: 10s
            restart_policy:
                condition: on-failure

    db:
        image: postgres:13
        volumes:
            - postgres_data:/var/lib/postgresql/data
        environment:
            - POSTGRES_DB=atria
            - POSTGRES_USER=atria
            - POSTGRES_PASSWORD=${DB_PASSWORD}
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U atria']
            interval: 5s
            timeout: 5s
            retries: 5

    nginx:
        image: nginx:alpine
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
            - ./static:/app/static:ro
            - ./media:/app/media:ro
        depends_on:
            - web

volumes:
    postgres_data:
